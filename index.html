const express = require('express');
const cors = require('cors');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json());

const API_KEY = process.env.GEMINI_API_KEY;

// --- SLIDE 2: GENERAR EXAMEN (TU CÓDIGO ORIGINAL SIN CAMBIOS) ---
app.post('/generar-examen', async (req, res) => {
    const { tema, tipo } = req.body;
    console.log(`Generando ${tipo} para tema: ${tema}`);

    const PROMPTS = {
        pa1: `[COMPUTACIÓN III - S10] Genera un examen práctico de Software S10 para el Producto Académico 1. CONTEXTO: Un proyecto de edificación residencial de mediana complejidad en Trujillo. REQUISITOS: 1. Datos del proyecto. 2. Tabla de 10 Recursos con precios reales. 3. Planilla de metrados (6 partidas). 4. Datos para APU.`,
        parcial: `[COMPUTACIÓN III - S10 - EXAMEN SECUENCIAL] Tarea: Generar un EXAMEN PARCIAL de S10 basado en el tema "${tema}". El examen debe ser secuencial: el resultado del Ejercicio 1 se usa en el Ejercicio 2. ESTRUCTURA OBLIGATORIA DEL EXAMEN: 1. DATOS GENERALES DEL PRESUPUESTO (Formato S10): Generar una ficha técnica con: Crear Grupo Nuevo, Descripción del Presupuesto, Cliente, Ubicación Geográfica, Fecha, Plazo y Jornada (8h). 2. EJERCICIO 1: DETERMINACIÓN DEL COSTO DIRECTO. - Presenta una tabla con 8 partidas técnicas reales (Incluye Títulos y Subtítulos de especialidades). - Columnas OBLIGATORIAS: [Ítem], [Descripción de Partida], [Unidad], [Metrado], [Costo Unitario S/.], [Parcial S/.]. - IMPORTANTE: La columna "Parcial S/." debe estar vacía para que el alumno la calcule. - El alumno debe hallar la sumatoria total que representa el COSTO DIRECTO (C.D.). 3. EJERCICIO 2: DISEÑO DEL PIE DE PRESUPUESTO (Continuación). - Instrucción: "Con el Costo Directo obtenido en el Ejercicio 1, desarrolle el Pie de Presupuesto según los siguientes parámetros". - Provee datos específicos: % de Gastos Generales (10-15%), % de Utilidad (5-10%) e IGV (18%). - NO incluyas tablas de recursos aquí; enfócate en la estructura de costos indirectos. 4. CUESTIONARIO DE EVALUACIÓN: Generar lista numerada: 1. Calcular C.D. Total. 2. Determinar GG, Utilidad y Subtotal. 3. Calcular IGV y Total de Obra. 4. Pregunta teórica sobre configuración de Pie de Presupuesto en S10. REGLA DE CALIDAD: Los costos y metrados deben tener coherencia técnica con la ingeniería peruana.`,
        pa2: `[NIVEL: PLANIFICADOR DE PROYECTOS / MS PROJECT EXPERT] Tarea: Generar un examen PA2 sobre MS PROJECT enfocado en MÉTODO PERT y ESTRUCTURA JERÁRQUICA. REQUISITOS: 1. Calendario y Feriado. 2. EDT con FASES y SUBTAREAS. 3. MÉTODO PERT usando campos de Duración1, 2 y 3. 4. Cálculo de Ruta Crítica. 5. Preguntas de análisis final.`,
        final: `[NIVEL: DIRECTOR DE PROYECTOS / MS PROJECT EXPERT - EXAMEN INTEGRAL SECUENCIAL] Tarea: Generar un EXAMEN FINAL de MS PROJECT basado en el tema "${tema}". El examen debe ser una secuencia técnica: el cronograma del Ejercicio 1 es la base para el costo del Ejercicio 2. ESTRUCTURA OBLIGATORIA DEL EXAMEN: 1. CONFIGURACIÓN ENTORNO (Ficha Técnica): - Nombre del Proyecto, Fecha de Inicio (Lunes próximo), Calendario laboral (8h/día) y un día feriado. 2. EJERCICIO 1: PROGRAMACIÓN, GANTT Y RUTA CRÍTICA. - Presenta una tabla con la EDT Jerárquica (Fases y Subtareas, mín. 12 líneas). - Columnas: [EDT], [Nombre de la Tarea], [Predecesoras], [Duración]. - Incluir al menos 3 Hitos (Duración 0). - El alumno debe ingresar los datos para hallar la FECHA FINAL y la RUTA CRÍTICA. 3. EJERCICIO 2: GESTIÓN DE RECURSOS Y COSTO DEL PROYECTO (Continuación). - Instrucción: "Continuando con la programación anterior, asigne los siguientes recursos para determinar el costo total". - Presenta una TABLA DE RECURSOS: [Nombre del Recurso], [Tipo (Trabajo/Material)], [Unidad], [Tasa Estándar S/.]. - Indica qué recursos se asignan a qué tareas del Ejercicio 1 de forma clara. 4. CUESTIONARIO DE EVALUACIÓN FINAL: Generar lista numerada: 1. Indicar la duración total del proyecto en días útiles y la fecha de finalización. 2. Identificar las tareas que conforman la Ruta Crítica. 3. Calcular el Costo Total del Proyecto (Suma de recursos asignados). 4. Pregunta teórica: "Explique cómo se visualiza el Informe de Costos y el Flujo de Caja en MS Project". REGLA DE CALIDAD: La lógica de predecesoras debe ser coherente para evitar errores de programación en el software.`
    };

    const instruccionTipo = PROMPTS[tipo] || PROMPTS.pa1;
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

    const rolIngeniero = (tipo === 'pa2' || tipo === 'final') 
        ? "Ingeniero experto en Planificación y Control de Proyectos con MS PROJECT" 
        : "Ingeniero experto en Costos y Presupuestos con software S10";

    const payload = {
        contents: [{
            parts: [{
                text: `Actúa como: ${rolIngeniero}. Tarea: ${instruccionTipo}.
                REGLAS CRÍTICAS DE SALIDA: 1. NO incluyas saludos ni presentaciones. 2. NO incluyas comentarios iniciales ni finales. 3. EMPIEZA DIRECTAMENTE con el contenido del examen en HTML. 4. VE DIRECTO AL GRANO. REGLAS DE FORMATO HTML: - Usa etiquetas <h3> para títulos y <table> con border="1". - Tablas de recursos con columnas fijas: [Categoría], [Descripción], [Unidad], [Precio S/.]. - No uses bloques de código markdown, responde con el HTML puro.`
            }]
        }]
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await response.json();
        
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
            const textoIA = data.candidates[0].content.parts[0].text;
            res.json({ contenido: textoIA.replace(/```html|```/g, "") });
        } else {
            const url25 = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            const res25 = await fetch(url25, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const data25 = await res25.json();
            const texto25 = data25.candidates[0].content.parts[0].text;
            res.json({ contenido: texto25.replace(/```html|```/g, "") });
        }
    } catch (error) {
        res.status(500).json({ contenido: "Error IA: " + error.message });
    }
});

// --- SLIDE 3: GENERAR QUIZ (REDISEÑADO PARA COMPATIBILIDAD TOTAL) ---
app.post('/generar-quiz', async (req, res) => {
    const { tema, tipo } = req.body;
    const software = (tipo === 'pa2' || tipo === 'final') ? "MS PROJECT" : "S10";

    const promptQuiz = `Actúa como Ingeniero experto en ${software}. Genera 40 preguntas técnicas (20 opción múltiple y 20 match) sobre "${tema}" para copiar y pegar en un generador de Blackboard.
    
    ESTRUCTURA OBLIGATORIA:
    ---BLOQUE_MULTIPLE---
    (Usa este formato para 20 preguntas):
    1. Pregunta?
    a) Opción
    *b) Respuesta correcta con asterisco
    c) Opción
    
    ---BLOQUE_MATCH---
    (Usa este formato para 20 preguntas):
    match 1. Relacione los conceptos técnicos:
    Término / Definición
    Término / Definición
    
    REGLA: Cero saludos, cero bloques de código markdown. Solo el texto plano.`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: promptQuiz }] }]
            })
        });
        
        const data = await response.json();
        
        if (data.candidates && data.candidates[0]) {
            const textoIA = data.candidates[0].content.parts[0].text.replace(/```/g, "");

            // Separación manual de bloques para evitar errores de JSON
            const partes = textoIA.split('---BLOQUE_MATCH---');
            const multi = partes[0].replace('---BLOQUE_MULTIPLE---', '').trim();
            const match = partes[1] ? partes[1].trim() : "No se generó el bloque de correspondencia.";

            res.json({
                multiple: multi,
                match: match
            });
        } else {
            res.status(500).json({ error: "La IA no respondió." });
        }
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

const PORT = process.env.PORT || 10000;
app.listen(PORT, () => console.log("Servidor Activo en puerto " + PORT));
